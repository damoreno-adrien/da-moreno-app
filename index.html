<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Order - Da Moreno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://fav.farm/üáÆüáπ" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-open { overflow: hidden; }
        #toast-container { position: fixed; top: 1.25rem; right: 1.25rem; z-index: 50; }
        .toast { transform: translateX(120%); transition: transform 0.3s ease-in-out; }
        .toast.show { transform: translateX(0); }
        .lang-btn.active { background-color: #2563eb; color: white; }
        .lang-btn:not(.active) { background-color: #e5e7eb; color: #374151; }
        .nav-link.active { color: #2563eb; border-bottom-color: #2563eb; }
    </style>
</head>
<body class="bg-gray-100">
    
    <div id="toast-container"></div>

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 pb-24 hidden">
        
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row justify-between sm:items-start gap-4">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-800" data-key="main_title">Da Moreno At Town</h1>
                    <p class="text-lg text-gray-500 mt-1" data-key="main_subtitle">Supply Order System</p>
                </div>
                <div class="w-full sm:w-auto flex flex-col sm:flex-row items-end sm:items-center gap-4">
                    <p id="user-display" class="text-sm text-gray-600 w-full sm:w-auto text-right sm:text-left"></p>
                    <div class="w-full sm:w-auto justify-between flex items-center gap-2">
                        <div id="lang-switcher" class="flex items-center gap-1 text-sm font-medium border border-gray-300 rounded-lg p-1">
                            <button data-lang="en" class="lang-btn px-2 py-1 rounded-md">EN</button>
                            <button data-lang="th" class="lang-btn px-2 py-1 rounded-md">TH</button>
                        </div>
                         <div class="relative sm:hidden">
                            <button id="menu-button" class="p-2 rounded-md hover:bg-gray-200">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                            </button>
                            <div id="mobile-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20">
                                <a href="./my-orders.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-key="my_orders">My Orders</a>
                                <a href="./admin.html" id="admin-link-mobile" class="hidden block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-key="admin_dashboard">Admin</a>
                                <button id="logout-btn-mobile" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-key="logout">Logout</button>
                            </div>
                        </div>
                        <div class="hidden sm:flex items-center gap-2">
                            <a href="./admin.html" id="admin-link" class="hidden flex-1 sm:flex-none justify-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700" data-key="admin_dashboard">Admin</a>
                            <button id="logout-btn" class="flex-1 sm:flex-none justify-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700" data-key="logout">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
            <nav class="mt-6 border-b hidden sm:block">
                <div class="flex items-center gap-6 text-gray-500">
                    <a href="./my-orders.html" class="nav-link py-3 border-b-2 border-transparent hover:text-blue-600" data-key="my_orders">My Orders</a>
                    <a href="./index.html" class="nav-link active py-3 border-b-2 font-semibold" data-key="create_order">Create Order</a>
                </div>
            </nav>
        </header>

        <div id="team-orders-dashboard" class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4" data-key="team_pending_orders">Team's Pending Orders</h2>
            <div id="team-pending-orders-list" class="space-y-4"></div>
            <div id="team-orders-loading" class="text-center py-6">
                <svg class="animate-spin h-6 w-6 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8-0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-2 text-gray-500" data-key="loading_team_orders">Loading team orders...</p>
            </div>
        </div>

        <div class="mb-8 p-4 bg-white rounded-lg shadow-sm">
            <h2 class="text-2xl font-bold text-gray-800 mb-4" data-key="product_catalog">Product Catalog</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="relative flex-grow">
                    <input type="text" id="searchInput" class="w-full pl-10 pr-10 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" data-key-placeholder="search_placeholder">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <button id="clearSearch" class="absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400 hover:text-gray-600 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8-0 100-16 8 8-0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <div id="category-filters" class="flex items-center gap-2 overflow-x-auto pb-2"></div>
            </div>
        </div>

        <main id="product-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></main>
        
        <div id="loading" class="text-center py-10">
             <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8-0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-2 text-gray-500" data-key="loading_products">Loading products...</p>
        </div>

        <button id="cart-button" class="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition-transform transform hover:scale-110 z-20">
            <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
            <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-6 w-6 flex items-center justify-center">0</span>
        </button>

        <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-30 p-4">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b">
                    <h2 id="cart-modal-title" class="text-2xl font-bold text-gray-800" data-key="current_order">Current Order</h2>
                    <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <div id="cart-items-container" class="p-6 overflow-y-auto"></div>
                <div class="p-6 border-t mt-auto">
                    <textarea id="order-notes" class="w-full p-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" data-key-placeholder="notes_placeholder"></textarea>
                    <div class="flex justify-end gap-4">
                        <button id="close-modal-btn-footer" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300" data-key="close">Close</button>
                        <button id="place-order-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                            <span id="place-order-text" data-key="place_order">Place Order</span>
                            <svg id="order-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8-0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, doc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDIqmK_P2JWz3Vr5-u_2b6s6hhyWO9c-sg",
            authDomain: "da-moreno-orders-app.firebaseapp.com",
            projectId: "da-moreno-orders-app",
            storageBucket: "da-moreno-orders-app.appspot.com",
            messagingSenderId: "545175404745",
            appId: "1:545175404745:web:4dc2df2c7d3f7b040d18",
            measurementId: "G-D7K1PT81Q4"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const appContainer = document.getElementById('app');
        const userDisplay = document.getElementById('user-display');
        const productGrid = document.getElementById('product-grid');
        const searchInput = document.getElementById('searchInput');
        const clearSearch = document.getElementById('clearSearch');
        const categoryFiltersContainer = document.getElementById('category-filters');
        const loadingIndicator = document.getElementById('loading');
        const cartButton = document.getElementById('cart-button');
        const cartCount = document.getElementById('cart-count');
        const cartModal = document.getElementById('cart-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const closeModalBtnFooter = document.getElementById('close-modal-btn-footer');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const placeOrderBtn = document.getElementById('place-order-btn');
        const orderNotes = document.getElementById('order-notes');
        const logoutBtn = document.getElementById('logout-btn');
        const logoutBtnMobile = document.getElementById('logout-btn-mobile');
        const toastContainer = document.getElementById('toast-container');
        const adminLink = document.getElementById('admin-link');
        const adminLinkMobile = document.getElementById('admin-link-mobile');
        const teamPendingOrdersList = document.getElementById('team-pending-orders-list');
        const teamOrdersLoading = document.getElementById('team-orders-loading');
        const placeOrderText = document.getElementById('place-order-text');
        const orderSpinner = document.getElementById('order-spinner');
        const langSwitcher = document.getElementById('lang-switcher');
        const menuButton = document.getElementById('menu-button');
        const mobileMenu = document.getElementById('mobile-menu');

        let allProducts = [], allDepartments = [], allStaff = [];
        let teamPendingOrders = [];
        let currentFilter = 'All';
        let cart = [];
        let currentUser, userDepartment;
        let currentLang = localStorage.getItem('appLanguage') || 'en';

        const translations = {
            en: {
                main_title: "Da Moreno At Town",
                main_subtitle: "Supply Order System",
                admin_dashboard: "Admin",
                logout: "Logout",
                my_orders: "My Orders",
                create_order: "Create Order",
                team_pending_orders: "Team's Pending Orders",
                loading_team_orders: "Loading team orders...",
                product_catalog: "Product Catalog",
                search_placeholder: "Search for a product...",
                loading_products: "Loading products...",
                current_order: "Current Order",
                notes_placeholder: "Add any special notes for this order...",
                close: "Close",
                place_order: "Place Order",
                logged_in_as: "Logged in as:"
            },
            th: {
                main_title: "‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏≤‡πÇ‡∏°‡πÄ‡∏£‡πÇ‡∏ô‡πà",
                main_subtitle: "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö",
                admin_dashboard: "‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô",
                logout: "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö",
                my_orders: "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô",
                create_order: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠",
                team_pending_orders: "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°",
                loading_team_orders: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°...",
                product_catalog: "‡πÅ‡∏Ñ‡∏ï‡∏ï‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",
                search_placeholder: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...",
                loading_products: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...",
                current_order: "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô",
                notes_placeholder: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ...",
                close: "‡∏õ‡∏¥‡∏î",
                place_order: "‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠",
                logged_in_as: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠:"
            }
        };

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('appLanguage', lang);
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.dataset.key;
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
             document.querySelectorAll('[data-key-placeholder]').forEach(el => {
                const key = el.dataset.keyPlaceholder;
                if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
            document.querySelectorAll('.lang-btn').forEach(btn => {
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            renderProducts();
            renderCategoryFilters();
            renderTeamPendingOrders();
        }

        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `toast text-white py-3 px-6 rounded-lg shadow-lg mb-2 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 3000);
        }

        // --- Cart Persistence Functions ---
        function saveCart() {
            if (currentUser) {
                sessionStorage.setItem(`cart_${currentUser.uid}`, JSON.stringify(cart));
            }
        }

        function loadCart() {
            if (!currentUser) return;
            
            const reorderData = localStorage.getItem('reorderCart');
            if (reorderData) {
                cart = JSON.parse(reorderData);
                localStorage.removeItem('reorderCart');
                saveCart();
                toggleModal(true); 
            } else {
                const savedCart = sessionStorage.getItem(`cart_${currentUser.uid}`);
                cart = savedCart ? JSON.parse(savedCart) : [];
            }
        }
        // --- End Cart Persistence ---
        
        function addToCart(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            const cartItem = cart.find(item => item.productId === productId);
            if (cartItem) { cartItem.quantity++; } else { cart.push({ productId: product.id, productName: product.name_en, productName_th: product.name_th, packaging: product.packaging_en, packaging_th: product.packaging_th, quantity: 1, supplier: product.supplier, productRef: product.product_reference }); }
            showToast(`${product[`name_${currentLang}`]} added to order.`);
            updateCart();
        }

        function updateCart() {
            cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartItemsContainer.innerHTML = '';
            
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = `<p class="text-gray-500 text-center">${currentLang === 'th' ? '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤' : 'Your order is empty.'}</p>`;
                placeOrderBtn.disabled = true;
                placeOrderBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                placeOrderBtn.disabled = false; 
                placeOrderBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                cart.forEach(item => {
                    // This is the modified line
                    const itemHtml = `<div class="flex items-center justify-between py-3 border-b last:border-b-0"><div><p class="font-semibold">${item[`productName_${currentLang}`] || item.productName}</p><p class="text-sm text-gray-500">${currentLang === 'th' ? '‡∏ï‡πà‡∏≠' : 'Per'} ${item[`packaging_${currentLang}`] || item.packaging}</p></div><div class="flex items-center gap-3"><button data-id="${item.productId}" class="quantity-btn decrease-quantity bg-gray-200 h-7 w-7 rounded-full font-bold text-lg flex items-center justify-center">-</button><input type="number" data-id="${item.productId}" class="quantity-input shadow-sm border rounded w-16 text-center py-1" value="${item.quantity}" min="0"><button data-id="${item.productId}" class="quantity-btn increase-quantity bg-gray-200 h-7 w-7 rounded-full font-bold text-lg flex items-center justify-center">+</button><button data-id="${item.productId}" class="remove-item text-red-500 hover:text-red-700 ml-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div></div>`;
                    cartItemsContainer.insertAdjacentHTML('beforeend', itemHtml);
                });
            }
            saveCart();
        }

        function toggleModal(show) {
            if (show) { 
                cartModal.classList.remove('hidden'); 
                cartModal.classList.add('flex'); 
                document.body.classList.add('modal-open'); 
            } else { 
                cartModal.classList.add('hidden'); 
                cartModal.classList.remove('flex'); 
                document.body.classList.remove('modal-open');
            }
        }

        function resetCartState() {
            cart = [];
            orderNotes.value = '';
            updateCart();
        }

        function renderProducts() {
            productGrid.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase();
            const filteredProducts = allProducts.filter(product => {
                const nameEn = product.name_en || '';
                const nameTh = product.name_th || '';
                const ref = product.product_reference || '';
                const keywords = product.keywords || '';
                return (currentFilter === (currentLang === 'th' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'All') || product[`category_${currentLang}`] === currentFilter) && 
                       (nameEn.toLowerCase().includes(searchTerm) || 
                        nameTh.toLowerCase().includes(searchTerm) || 
                        ref.toLowerCase().includes(searchTerm) ||
                        keywords.toLowerCase().includes(searchTerm));
            });
            if (filteredProducts.length === 0 && allProducts.length > 0) { productGrid.innerHTML = `<p class="text-gray-500 col-span-full text-center">${currentLang === 'th' ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'No products found.'}</p>`; return; }
            filteredProducts.forEach(product => {
                const card = `<div class="bg-white rounded-lg shadow-md overflow-hidden transition-transform transform hover:-translate-y-1 flex flex-col"><img src="${product.imageUrl || 'https://placehold.co/400x400/e2e8f0/64748b?text=No+Img'}" alt="${product.name_en}" class="w-full h-40 object-cover"><div class="p-4 flex flex-col flex-grow"><h3 class="font-semibold text-lg truncate">${product[`name_${currentLang}`]}</h3><p class="text-gray-500 text-sm">Ref: ${product.product_reference || 'N/A'}</p><div class="flex items-center justify-between mt-4 pt-2 border-t mt-auto"><span class="text-gray-600 font-medium">${currentLang === 'th' ? '‡∏ï‡πà‡∏≠' : 'Per'} ${product[`packaging_${currentLang}`]}</span><button data-id="${product.id}" class="add-to-cart-btn bg-blue-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">${currentLang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°' : 'Add'}</button></div></div></div>`;
                productGrid.insertAdjacentHTML('beforeend', card);
            });
        }

        function renderCategoryFilters() {
            const allKey = currentLang === 'th' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'All';
            const categories = [allKey, ...new Set(allProducts.map(p => p[`category_${currentLang}`]).filter(Boolean).sort())];
            categoryFiltersContainer.innerHTML = '';
            categories.forEach(category => {
                const isActive = category === currentFilter;
                const buttonClass = isActive ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300';
                const button = `<button data-category="${category}" class="category-filter-btn whitespace-nowrap px-4 py-2 rounded-lg text-sm font-medium transition-colors ${buttonClass}">${category}</button>`;
                categoryFiltersContainer.insertAdjacentHTML('beforeend', button);
            });
        }

        function fetchProducts() {
            loadingIndicator.classList.remove('hidden');
            const productsCol = collection(db, "products");
            onSnapshot(productsCol, (snapshot) => {
                allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(product => product.isActive !== false);
                loadingIndicator.classList.add('hidden');
                renderCategoryFilters();
                renderProducts();
            }, (error) => {
                console.error("Error fetching products: ", error);
                loadingIndicator.innerHTML = `<p class="text-red-500 text-center">${currentLang === 'th' ? '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ' : 'Could not load products.'}</p>`;
            });
        }
        
        async function handlePlaceOrder() {
            if (!userDepartment) { showToast(currentLang === 'th' ? '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏ú‡∏ô‡∏Å' : 'Department not assigned.', true); return; }
            if (cart.length === 0) { showToast(currentLang === 'th' ? '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤' : 'Your order is empty.', true); return; }

            placeOrderBtn.disabled = true; 
            placeOrderText.classList.add('hidden'); 
            orderSpinner.classList.remove('hidden');

            try {
                const orderData = { departmentId: userDepartment.id, departmentName: userDepartment.name_en, departmentName_th: userDepartment.name_th, status: "Pending", notes: orderNotes.value.trim(), items: cart, userId: currentUser.uid, createdAt: serverTimestamp() };
                await addDoc(collection(db, "orders"), orderData);
                showToast(currentLang === 'th' ? '‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : 'Order placed successfully!');
                toggleModal(false);
                resetCartState();
            } catch (error) { 
                console.error("Error saving order: ", error); 
                showToast(currentLang === 'th' ? '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ' : 'Failed to save order.', true);
            } finally { 
                placeOrderBtn.disabled = false; 
                placeOrderText.classList.remove('hidden'); 
                orderSpinner.classList.add('hidden'); 
            }
        }

        function renderTeamPendingOrders() {
            teamPendingOrdersList.innerHTML = '';
            if (teamPendingOrders.length === 0) {
                teamPendingOrdersList.innerHTML = `<div class="bg-white p-4 rounded-lg shadow-sm text-center text-gray-500">${currentLang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì' : 'No pending orders in your team.'}</div>`;
                return;
            }
            teamPendingOrders.forEach(order => {
                const user = allStaff.find(u => u.id === order.userId);
                const userName = user ? user.name : 'Unknown';
                const itemsHtml = order.items.map(item => `<li class="text-gray-600">${item.quantity} x ${item[`productName_${currentLang}`] || item.productName}</li>`).join('');
                const orderHtml = `
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-bold">${userName}</p>
                        <ul class="list-disc list-inside mt-2">${itemsHtml}</ul>
                    </div>
                `;
                teamPendingOrdersList.insertAdjacentHTML('beforeend', orderHtml);
            });
        }

        function fetchTeamPendingOrders() {
            if (!userDepartment) return;
            teamOrdersLoading.classList.remove('hidden');
            const q = query(collection(db, "orders"), where("departmentId", "==", userDepartment.id), where("status", "==", "Pending"));
            onSnapshot(q, (snapshot) => {
                teamPendingOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                teamOrdersLoading.classList.add('hidden');
                renderTeamPendingOrders();
            }, (error) => {
                console.error("Error fetching team orders:", error);
                teamOrdersLoading.innerHTML = `<p class="text-red-500 text-center">${currentLang === 'th' ? '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ' : 'Could not load team orders.'}</p>`;
            });
        }
        
        function fetchAllStaff() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                allStaff = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTeamPendingOrders();
            });
        }
        
        async function initializeAppForUser(user) {
            currentUser = user;
            loadCart(); // Load cart from session or handle reorder

            const userDocRef = doc(db, "users", user.uid);
            try {
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    if(userDisplay && userData.name) {
                         userDisplay.textContent = `${translations[currentLang].logged_in_as} ${userData.name}`;
                    }
                    if (userData.departmentId === 'qu76BRyA9CS1XTqSay4X') {
                        adminLink.classList.remove('hidden');
                        adminLinkMobile.classList.remove('hidden');
                    }
                    if (userData.departmentId) {
                        const departmentDocRef = doc(db, "departments", userData.departmentId);
                        const departmentDoc = await getDoc(departmentDocRef);
                        if (departmentDoc.exists()) {
                            userDepartment = { id: departmentDoc.id, ...departmentDoc.data() };
                            fetchAllStaff();
                            fetchTeamPendingOrders();
                        } else { showToast("Assigned department not found.", true); }
                    } else { showToast("User has no assigned department.", true); }
                } else { showToast("User profile not found in database.", true); }
            } catch (error) { console.error("Error fetching user data:", error); showToast("Could not fetch user data.", true); }
            appContainer.classList.remove('hidden');
            fetchProducts();
            updateCart();
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user) { 
                setLanguage(currentLang);
                initializeAppForUser(user); 
            } else { 
                window.location.href = './login.html'; 
            }
        });
        
        langSwitcher.addEventListener('click', (e) => {
            const lang = e.target.dataset.lang;
            if (lang) { setLanguage(lang); }
        });

        menuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!menuButton.contains(e.target) && !mobileMenu.contains(e.target)) {
                mobileMenu.classList.add('hidden');
            }
        });

        function handleSearchInput(inputElement, clearButton) {
             if (inputElement.value) {
                clearButton.classList.remove('hidden');
            } else {
                clearButton.classList.add('hidden');
            }
            renderProducts();
        }
        searchInput.addEventListener('input', () => handleSearchInput(searchInput, clearSearch));
        clearSearch.addEventListener('click', () => {
            searchInput.value = '';
            handleSearchInput(searchInput, clearSearch);
        });

        categoryFiltersContainer.addEventListener('click', (e) => { 
            const btn = e.target.closest('.category-filter-btn');
            if (btn) { 
                currentFilter = btn.dataset.category; 
                renderCategoryFilters(); 
                renderProducts(); 
            } 
        });
        productGrid.addEventListener('click', (e) => { if (e.target.closest('.add-to-cart-btn')) { addToCart(e.target.closest('.add-to-cart-btn').dataset.id); } });
        
        cartItemsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.quantity-btn, .remove-item');
            if (!button) return;
            const productId = button.dataset.id;
            const itemInCart = cart.find(item => item.productId === productId);
            if (button.classList.contains('increase-quantity')) { itemInCart.quantity++; } 
            else if (button.classList.contains('decrease-quantity')) { if (itemInCart.quantity > 1) { itemInCart.quantity--; } else { cart = cart.filter(item => item.productId !== productId); } } 
            else if (button.classList.contains('remove-item')) { cart = cart.filter(item => item.productId !== productId); }
            updateCart();
        });

        cartItemsContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('quantity-input')) {
                const productId = e.target.dataset.id;
                let newQuantity = parseInt(e.target.value, 10);
                const itemInCart = cart.find(item => item.productId === productId);
                if (!itemInCart) return;
                
                if (isNaN(newQuantity) || newQuantity <= 0) {
                    cart = cart.filter(item => item.productId !== productId);
                } else {
                    itemInCart.quantity = newQuantity;
                }
                updateCart(); // Re-render the cart to reflect the change
            }
        });
        
        placeOrderBtn.addEventListener('click', handlePlaceOrder);
        
        cartButton.addEventListener('click', () => {
            updateCart();
            toggleModal(true);
        });

        // --- FIX: Removed resetCartState() from modal close events ---
        closeModalBtn.addEventListener('click', () => {
            toggleModal(false);
        });
        closeModalBtnFooter.addEventListener('click', () => {
             toggleModal(false);
        });
        cartModal.addEventListener('click', (e) => { 
            if (e.target === cartModal) {
                toggleModal(false);
            }
        });
        
        const logout = () => {
            signOut(auth);
            localStorage.removeItem('appLanguage');
            // Also clear session storage for the user on logout
            if(currentUser) {
                sessionStorage.removeItem(`cart_${currentUser.uid}`);
            }
        }
        logoutBtn.addEventListener('click', logout);
        logoutBtnMobile.addEventListener('click', logout);

    </script>
</body>
</html>
